<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>UserPaginationServiceImpl.java</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">springboot-boilerplate</a> &gt; <a href="index.source.html"
                                                                                  class="el_package">com.backend.boilerplate.service.impl</a>
    &gt; <span class="el_source">UserPaginationServiceImpl.java</span></div>
<h1>UserPaginationServiceImpl.java</h1>
<pre class="source lang-java linenums">package com.backend.boilerplate.service.impl;

import com.backend.boilerplate.config.ApplicationProperties;
import com.backend.boilerplate.dao.UserRepository;
import com.backend.boilerplate.dto.UserDto;
import com.backend.boilerplate.dto.UserPageDto;
import com.backend.boilerplate.entity.User;
import com.backend.boilerplate.service.UserService;
import com.backend.boilerplate.util.FunctionalReadWriteLock;
import lombok.extern.log4j.Log4j2;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.concurrent.atomic.AtomicLong;
import java.util.stream.Collectors;

/**
 * @author sarvesh
 * @version 0.0.1
 * @since 0.0.1
 */
<span class="nc" id="L33">@Log4j2</span>
@Service(&quot;UserPaginationService&quot;)
<span class="nc" id="L35">public class UserPaginationServiceImpl extends AbstractPaginationService&lt;User, UserPageDto&gt; {</span>

    @Autowired
    private ApplicationProperties applicationProperties;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private UserService userService;

<span class="nc" id="L46">    private final AtomicLong totalRecords = new AtomicLong(0);</span>

<span class="nc"
      id="L48">    private final FunctionalReadWriteLock totalRecordsGuard = new FunctionalReadWriteLock();</span>

    @Override
    public void setSortingParameters() {
<span class="nc" id="L52">        this.sortParameters = applicationProperties.getSort().getUser().getParams();</span>
<span class="nc" id="L53">    }</span>

    @Override
    public void setDefaultSortParameter() {
<span class="nc" id="L57">        this.defaultSort = applicationProperties.getSort().getUser().getDefaultParam();</span>
<span class="nc" id="L58">    }</span>

    @Override
    @Transactional
    public UserPageDto getPageDto(final Integer pageNo, final Integer pageSize, final String sortBy,
                                  final boolean isAscending) {
<span class="nc" id="L64">        UserPageDto userPageDto = new UserPageDto();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (!isValidPageNo(pageNo, pageSize)) {</span>
<span class="nc" id="L66">            return userPageDto;</span>
        }
<span class="nc" id="L68">        Pageable pageable = this.getPageable(Optional.ofNullable(pageNo),</span>
<span class="nc" id="L69">            Optional.ofNullable(pageSize), Optional.ofNullable(sortBy), isAscending);</span>
<span class="nc" id="L70">        Page&lt;User&gt; pagedResult = userRepository.findAll(pageable);</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (pagedResult.hasContent()) {</span>
<span class="nc" id="L72">            final List&lt;User&gt; users = pagedResult.getContent();</span>
<span class="nc" id="L73">            List&lt;UserDto&gt; userList = users.stream()</span>
<span class="nc" id="L74">                .map(user -&gt; userService.prepareUserDto(user))</span>
<span class="nc" id="L75">                .collect(Collectors.toList());</span>
<span class="nc" id="L76">            userPageDto.setUsers(userList);</span>
<span class="nc" id="L77">            totalRecordsGuard.write(() -&gt; totalRecords.set(pagedResult.getTotalElements()));</span>
<span class="nc"
      id="L78">            totalRecordsGuard.read(() -&gt; userPageDto.setTotalRecords(totalRecords.get()));</span>
        }
<span class="nc" id="L80">        return userPageDto;</span>
    }

    private boolean isValidPageNo(Integer pageNo, Integer pageSize) {
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (Objects.nonNull(pageNo)) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (Objects.isNull(pageSize)) {</span>
<span class="nc" id="L86">                pageSize = this.getDefaultPageSize();</span>
            }
<span class="nc" id="L88">            AtomicLong totalPages = new AtomicLong();</span>
<span class="nc" id="L89">            Integer finalPageSize = pageSize;</span>
<span class="nc" id="L90">            totalRecordsGuard.read(() -&gt; totalPages.set((totalRecords.get() / finalPageSize) + 1));</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if (pageNo &gt; totalPages.get()) {</span>
<span class="nc" id="L92">                totalRecordsGuard.write(() -&gt; {</span>
<span class="nc" id="L93">                    long totalElements = userRepository.count();</span>
<span class="nc" id="L94">                    totalRecords.set(totalElements);</span>
<span class="nc" id="L95">                    totalPages.set((totalRecords.get() / finalPageSize) + 1);</span>
<span class="nc" id="L96">                });</span>
<span class="nc bnc" id="L97"
      title="All 2 branches missed.">                return pageNo &lt;= totalPages.get();</span>
            }
        }
<span class="nc" id="L100">        return true;</span>
    }
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span>
</div>
</body>
</html>