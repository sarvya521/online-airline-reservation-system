<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>UserServiceImpl.java</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">springboot-boilerplate</a> &gt; <a href="index.source.html"
                                                                                  class="el_package">com.backend.boilerplate.service.impl</a>
    &gt; <span class="el_source">UserServiceImpl.java</span></div>
<h1>UserServiceImpl.java</h1>
<pre class="source lang-java linenums">package com.backend.boilerplate.service.impl;

import com.backend.boilerplate.dao.RoleRepository;
import com.backend.boilerplate.dao.UserHistoryRepository;
import com.backend.boilerplate.dao.UserRepository;
import com.backend.boilerplate.dao.UserRoleRepository;
import com.backend.boilerplate.dto.CreateUserDto;
import com.backend.boilerplate.dto.UpdateUserDto;
import com.backend.boilerplate.dto.UserDto;
import com.backend.boilerplate.dto.UserRoleDto;
import com.backend.boilerplate.entity.Role;
import com.backend.boilerplate.entity.Status;
import com.backend.boilerplate.entity.User;
import com.backend.boilerplate.entity.UserHistory;
import com.backend.boilerplate.entity.UserRole;
import com.backend.boilerplate.exception.RoleNotFoundException;
import com.backend.boilerplate.exception.UserNotFoundException;
import com.backend.boilerplate.modelmapper.RoleMapper;
import com.backend.boilerplate.modelmapper.UserMapper;
import com.backend.boilerplate.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionCallbackWithoutResult;
import org.springframework.transaction.support.TransactionTemplate;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Collectors;

import static com.backend.boilerplate.constant.Role.DEFAULT;

/**
 * Implementation of {@link UserService}.
 *
* @author sarvesh
 * @version 0.0.1
 * @since 0.0.1
 */
@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private UserHistoryRepository userHistoryRepository;

    @Autowired
    private RoleRepository roleRepository;

    @Autowired
    private UserRoleRepository userRoleRepository;

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private RoleMapper roleMapper;

//    @Autowired
//    private IAuthenticationFacade authenticationFacade;

    private final TransactionTemplate transactionTemplate;

<span class="nc" id="L75">    public UserServiceImpl(PlatformTransactionManager transactionManager) {</span>
<span class="nc" id="L76">        this.transactionTemplate = new TransactionTemplate(transactionManager);</span>
        //this.transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_SERIALIZABLE);
<span class="nc" id="L78">    }</span>

    @Override
    public UserDto prepareUserDto(User user) {
<span class="nc" id="L82">        UserDto userDto = userMapper.convertToDto(user);</span>

<span class="nc" id="L84">        List&lt;Role&gt; roles = user.getUserRoles().stream()</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            .filter(userRole -&gt; !userRole.getRole().getName().equals(DEFAULT.getName()))</span>
<span class="nc" id="L86">            .map(UserRole::getRole)</span>
<span class="nc" id="L87">            .collect(Collectors.toList());</span>
<span class="nc" id="L88">        List&lt;UserRoleDto&gt; roleDtos = roleMapper.convertToUserRoleDtos(roles);</span>
<span class="nc" id="L89">        userDto.setRoles(roleDtos);</span>

<span class="nc" id="L91">        return userDto;</span>
    }

    /**
     * @param uuid uuid of user
     * @return UserDto
     */
    @Override
    @Transactional
    public UserDto getUserByUuid(UUID uuid) {
<span class="nc" id="L101">        Optional&lt;User&gt; userOptional = userRepository.findByUuid(uuid);</span>
<span class="nc" id="L102">        User user = userOptional.orElseThrow(UserNotFoundException::new);</span>
<span class="nc" id="L103">        return prepareUserDto(user);</span>
    }

    @Override
    @Transactional
    public UserDto createUser(CreateUserDto createUserDto) {
<span class="nc" id="L109">        Long createdBy = -1l;</span>
//        userRepository.findIdByUuid(authenticationFacade.getUserId())
//            .orElseThrow(InvalidUserException::new);

<span class="nc" id="L113">        UserDto userDto = userMapper.convertToDto(createUserDto);</span>

<span class="nc" id="L115">        User user = userMapper.convertToEntity(userDto);</span>
<span class="nc" id="L116">        user.setStatus(Status.CREATED);</span>
<span class="nc" id="L117">        user.setPerformedBy(createdBy);</span>

<span class="nc" id="L119">        List&lt;UserRole&gt; userRoles = createUserDto.getRoles().stream()</span>
<span class="nc" id="L120">            .map(roleUuid -&gt; roleRepository.findByUuid(roleUuid).orElseThrow(RoleNotFoundException::new))</span>
<span class="nc" id="L121">            .map(role -&gt; new UserRole(user, role))</span>
<span class="nc" id="L122">            .collect(Collectors.toList());</span>

<span class="nc" id="L124">        Role defaultRole = roleRepository.findByNameIgnoreCase(DEFAULT.getName())</span>
<span class="nc" id="L125">            .orElseThrow(RoleNotFoundException::new);</span>
<span class="nc" id="L126">        userRoles.add(new UserRole(user, defaultRole));</span>

<span class="nc" id="L128">        transactionTemplate.execute(new TransactionCallbackWithoutResult() {</span>
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus status) {
<span class="nc" id="L131">                User userPersisted = userRepository.saveAndFlush(user);</span>
<span class="nc" id="L132">                UserHistory userHistory = UserHistory.builder()</span>
<span class="nc" id="L133">                    .id(new UserHistory.UserHistoryId(user.getId()))</span>
<span class="nc" id="L134">                    .uuid(user.getUuid())</span>
<span class="nc" id="L135">                    .email(user.getEmail())</span>
<span class="nc" id="L136">                    .firstName(user.getFirstName())</span>
<span class="nc" id="L137">                    .lastName(user.getLastName())</span>
<span class="nc" id="L138">                    .status(user.getStatus())</span>
<span class="nc" id="L139">                    .performedBy(user.getPerformedBy())</span>
<span class="nc" id="L140">                    .build();</span>
<span class="nc" id="L141">                userHistoryRepository.save(userHistory);</span>

<span class="nc" id="L143">                userRoles.forEach(userRole -&gt; userRole.setUser(userPersisted));</span>
<span class="nc" id="L144">                userRoleRepository.saveAll(userRoles);</span>
<span class="nc" id="L145">            }</span>
        });
<span class="nc" id="L147">        return prepareUserDto(user);</span>
    }

    @Override
    @Transactional
    public UserDto updateUser(UpdateUserDto updateUserDto) {
<span class="nc" id="L153">        Long updatedBy = -1l;</span>
//        userRepository.findIdByUuid(authenticationFacade.getUserId())
//            .orElseThrow(InvalidUserException::new);

<span class="nc" id="L157">        UUID uuid = updateUserDto.getUuid();</span>
<span class="nc" id="L158">        User user = userRepository.findByUuid(uuid)</span>
<span class="nc" id="L159">            .orElseThrow(UserNotFoundException::new);</span>

<span class="nc" id="L161">        UserDto userDto = userMapper.convertToDto(updateUserDto);</span>
<span class="nc" id="L162">        userMapper.mergeToEntity(userDto, user);</span>
<span class="nc" id="L163">        user.setStatus(Status.UPDATED);</span>
<span class="nc" id="L164">        user.setPerformedBy(updatedBy);</span>

<span class="nc" id="L166">        List&lt;UserRole&gt; existingUserRoles = user.getUserRoles();</span>
<span class="nc" id="L167">        List&lt;UserRole&gt; newUserRoles = updateUserDto.getRoles().stream()</span>
<span class="nc" id="L168">            .map(roleUuid -&gt; roleRepository.findByUuid(roleUuid).orElseThrow(RoleNotFoundException::new))</span>
<span class="nc" id="L169">            .map(role -&gt; new UserRole(user, role))</span>
<span class="nc" id="L170">            .collect(Collectors.toList());</span>

<span class="nc" id="L172">        user.getUserRoles().stream()</span>
<span class="nc"
      id="L173">            .filter(userRole -&gt; userRole.getRole().getName().equals(DEFAULT.getName()))</span>
<span class="nc" id="L174">            .findFirst()</span>
<span class="nc" id="L175">            .ifPresent(newUserRoles::add);</span>

<span class="nc" id="L177">        List&lt;UserRole&gt; existingUserRolesToDelete = new ArrayList&lt;&gt;(existingUserRoles);</span>
<span class="nc" id="L178">        existingUserRolesToDelete.removeAll(newUserRoles);</span>
<span class="nc" id="L179">        newUserRoles.removeAll(existingUserRoles);</span>

<span class="nc" id="L181">        transactionTemplate.execute(new TransactionCallbackWithoutResult() {</span>
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus status) {
<span class="nc" id="L184">                userRepository.saveAndFlush(user);</span>
<span class="nc" id="L185">                UserHistory userHistory = UserHistory.builder()</span>
<span class="nc" id="L186">                    .id(new UserHistory.UserHistoryId(user.getId()))</span>
<span class="nc" id="L187">                    .uuid(user.getUuid())</span>
<span class="nc" id="L188">                    .email(user.getEmail())</span>
<span class="nc" id="L189">                    .firstName(user.getFirstName())</span>
<span class="nc" id="L190">                    .lastName(user.getLastName())</span>
<span class="nc" id="L191">                    .status(user.getStatus())</span>
<span class="nc" id="L192">                    .performedBy(user.getPerformedBy())</span>
<span class="nc" id="L193">                    .build();</span>
<span class="nc" id="L194">                userHistoryRepository.save(userHistory);</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">                if (!existingUserRolesToDelete.isEmpty()) {</span>
<span class="nc" id="L197">                    userRoleRepository.deleteAll(existingUserRolesToDelete);</span>
                }
<span class="nc bnc" id="L199" title="All 2 branches missed.">                if (!newUserRoles.isEmpty()) {</span>
<span class="nc" id="L200">                    userRoleRepository.saveAll(newUserRoles);</span>
                }
<span class="nc" id="L202">            }</span>
        });
<span class="nc" id="L204">        return prepareUserDto(user);</span>
    }

    @Override
    @Transactional
    public void deleteUser(UUID uuid) {
<span class="nc" id="L210">        Long deletedBy = -1l;</span>
//        userRepository.findIdByUuid(authenticationFacade.getUserId())
//            .orElseThrow(InvalidUserException::new);

<span class="nc" id="L214">        User user = userRepository.findByUuid(uuid)</span>
<span class="nc" id="L215">            .orElseThrow(UserNotFoundException::new);</span>

<span class="nc" id="L217">        user.setStatus(Status.DELETED);</span>
<span class="nc" id="L218">        user.setPerformedBy(deletedBy);</span>

<span class="nc" id="L220">        transactionTemplate.execute(new TransactionCallbackWithoutResult() {</span>
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus status) {
<span class="nc" id="L223">                userRoleRepository.deleteAll(user.getUserRoles());</span>
<span class="nc" id="L224">                userRepository.delete(user);</span>
<span class="nc" id="L225">                UserHistory userHistory = UserHistory.builder()</span>
<span class="nc" id="L226">                    .id(new UserHistory.UserHistoryId(user.getId()))</span>
<span class="nc" id="L227">                    .uuid(user.getUuid())</span>
<span class="nc" id="L228">                    .email(user.getEmail())</span>
<span class="nc" id="L229">                    .firstName(user.getFirstName())</span>
<span class="nc" id="L230">                    .lastName(user.getLastName())</span>
<span class="nc" id="L231">                    .status(user.getStatus())</span>
<span class="nc" id="L232">                    .performedBy(user.getPerformedBy())</span>
<span class="nc" id="L233">                    .build();</span>
<span class="nc" id="L234">                userHistoryRepository.save(userHistory);</span>
<span class="nc" id="L235">            }</span>
        });
<span class="nc" id="L237">    }</span>
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span>
</div>
</body>
</html>