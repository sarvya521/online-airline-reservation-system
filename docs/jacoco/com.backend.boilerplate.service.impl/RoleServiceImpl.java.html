<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>RoleServiceImpl.java</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">springboot-boilerplate</a> &gt; <a href="index.source.html"
                                                                                  class="el_package">com.backend.boilerplate.service.impl</a>
    &gt; <span class="el_source">RoleServiceImpl.java</span></div>
<h1>RoleServiceImpl.java</h1>
<pre class="source lang-java linenums">package com.backend.boilerplate.service.impl;

import com.backend.boilerplate.dao.ClaimRepository;
import com.backend.boilerplate.dao.RoleClaimRepository;
import com.backend.boilerplate.dao.RoleHistoryRepository;
import com.backend.boilerplate.dao.RoleRepository;
import com.backend.boilerplate.dao.UserRepository;
import com.backend.boilerplate.dao.UserRoleRepository;
import com.backend.boilerplate.dto.ClaimDto;
import com.backend.boilerplate.dto.CreateRoleDto;
import com.backend.boilerplate.dto.RoleDto;
import com.backend.boilerplate.dto.UpdateRoleDto;
import com.backend.boilerplate.entity.Claim;
import com.backend.boilerplate.entity.Role;
import com.backend.boilerplate.entity.RoleClaim;
import com.backend.boilerplate.entity.RoleHistory;
import com.backend.boilerplate.entity.Status;
import com.backend.boilerplate.entity.UserRole;
import com.backend.boilerplate.exception.ClaimNotFoundException;
import com.backend.boilerplate.exception.RoleNotFoundException;
import com.backend.boilerplate.exception.UserManagementException;
import com.backend.boilerplate.modelmapper.ClaimMapper;
import com.backend.boilerplate.modelmapper.RoleMapper;
import com.backend.boilerplate.service.RoleService;
import com.backend.boilerplate.util.ErrorGenerator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionCallbackWithoutResult;
import org.springframework.transaction.support.TransactionTemplate;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

import static com.backend.boilerplate.constant.Role.DEFAULT;
import static com.backend.boilerplate.constant.Role.SYSTEM_ADMIN;

/**
 * Implementation of {@link RoleService}.
 *
 * @author sarvesh
 * @version 0.0.1
 * @since 0.0.1
 */
@Service
public class RoleServiceImpl implements RoleService {

    @Autowired
    private RoleRepository roleRepository;

    @Autowired
    private ClaimRepository claimRepository;

    @Autowired
    private RoleClaimRepository roleClaimRepository;

    @Autowired
    private RoleHistoryRepository roleHistoryRepository;

    @Autowired
    private UserRoleRepository userRoleRepository;

    @Autowired
    private RoleMapper roleMapper;

    @Autowired
    private ClaimMapper claimMapper;

//    @Autowired
//    private IAuthenticationFacade authenticationFacade;

    @Autowired
    private UserRepository userRepository;

    private final TransactionTemplate transactionTemplate;

<span class="nc" id="L86">    public RoleServiceImpl(PlatformTransactionManager transactionManager) {</span>
<span class="nc" id="L87">        this.transactionTemplate = new TransactionTemplate(transactionManager);</span>
<span class="nc" id="L88">    }</span>

    @Override
    public List&lt;RoleDto&gt; getAllRoles() {
<span class="nc" id="L92">        List&lt;Role&gt; roles = roleRepository.findAll();</span>
<span class="nc" id="L93">        return roles.stream()</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            .filter(role -&gt; !(role.getName().equals(DEFAULT.getName())</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                || role.getName().equals(SYSTEM_ADMIN.getName())))</span>
<span class="nc" id="L96">            .map(role -&gt; {</span>
<span class="nc" id="L97">                RoleDto roleDto = roleMapper.convertToDto(role);</span>
<span class="nc" id="L98">                List&lt;Claim&gt; claims = role.getRoleClaims().stream()</span>
<span class="nc" id="L99">                    .map(RoleClaim::getClaim).collect(Collectors.toList());</span>
<span class="nc" id="L100">                List&lt;ClaimDto&gt; claimDtos = claimMapper.convertToDtos(claims);</span>
<span class="nc" id="L101">                roleDto.setClaims(claimDtos);</span>
<span class="nc" id="L102">                return roleDto;</span>
<span class="nc" id="L103">            }).collect(Collectors.toList());</span>
    }

    @Override
    @Transactional
    public RoleDto createRole(CreateRoleDto createRoleDto) {
<span class="nc" id="L109">        Long createdBy = -1l;</span>
//        userRepository.findIdByUuid(authenticationFacade.getUserId())
//            .orElseThrow(InvalidUserException::new);

<span class="nc" id="L113">        Role role = roleMapper.convertToEntity(createRoleDto);</span>
<span class="nc" id="L114">        role.setStatus(Status.CREATED);</span>
<span class="nc" id="L115">        role.setPerformedBy(createdBy);</span>

<span class="nc" id="L117">        List&lt;RoleClaim&gt; roleClaims = createRoleDto.getClaims().stream()</span>
<span class="nc" id="L118">            .map(claimUuid -&gt; claimRepository.findByUuid(claimUuid).orElseThrow(ClaimNotFoundException::new))</span>
<span class="nc" id="L119">            .map(claim -&gt; new RoleClaim(role, claim))</span>
<span class="nc" id="L120">            .collect(Collectors.toList());</span>

<span class="nc" id="L122">        transactionTemplate.execute(new TransactionCallbackWithoutResult() {</span>
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus status) {
<span class="nc" id="L125">                Role rolePersisted = roleRepository.saveAndFlush(role);</span>
<span class="nc" id="L126">                RoleHistory roleHistory = RoleHistory.builder()</span>
<span class="nc" id="L127">                    .id(new RoleHistory.RoleHistoryId(role.getId()))</span>
<span class="nc" id="L128">                    .uuid(role.getUuid())</span>
<span class="nc" id="L129">                    .name(role.getName())</span>
<span class="nc" id="L130">                    .status(role.getStatus())</span>
<span class="nc" id="L131">                    .performedBy(role.getPerformedBy())</span>
<span class="nc" id="L132">                    .build();</span>
<span class="nc" id="L133">                roleHistoryRepository.save(roleHistory);</span>

<span class="nc" id="L135">                roleClaims.forEach(roleClaim -&gt; roleClaim.setRole(rolePersisted));</span>
<span class="nc" id="L136">                roleClaimRepository.saveAll(roleClaims);</span>
<span class="nc" id="L137">            }</span>
        });
<span class="nc" id="L139">        RoleDto roleDto = roleMapper.convertToDto(role);</span>
<span class="nc" id="L140">        List&lt;ClaimDto&gt; claimDtos = role.getRoleClaims().stream()</span>
<span class="nc" id="L141">            .map(RoleClaim::getClaim)</span>
<span class="nc" id="L142">            .map(claim -&gt; claimMapper.convertToClaimDto(claim))</span>
<span class="nc" id="L143">            .collect(Collectors.toList());</span>
<span class="nc" id="L144">        roleDto.setClaims(claimDtos);</span>
<span class="nc" id="L145">        return roleDto;</span>
    }

    @Override
    @Transactional
    public RoleDto updateRole(UpdateRoleDto updateRoleDto) {
<span class="nc" id="L151">        Long updatedBy = -1l;</span>
//        userRepository.findIdByUuid(authenticationFacade.getUserId())
//            .orElseThrow(InvalidUserException::new);

<span class="nc" id="L155">        UUID uuid = updateRoleDto.getUuid();</span>
<span class="nc" id="L156">        Role role = roleRepository.findByUuid(uuid)</span>
<span class="nc" id="L157">            .orElseThrow(RoleNotFoundException::new);</span>

<span class="nc" id="L159">        roleMapper.mergeToEntity(updateRoleDto, role);</span>
<span class="nc" id="L160">        role.setStatus(Status.UPDATED);</span>
<span class="nc" id="L161">        role.setPerformedBy(updatedBy);</span>

<span class="nc" id="L163">        List&lt;RoleClaim&gt; existingRoleClaims = role.getRoleClaims();</span>
<span class="nc" id="L164">        List&lt;RoleClaim&gt; newRoleClaims = updateRoleDto.getClaims().stream()</span>
<span class="nc" id="L165">            .map(claimUuid -&gt; claimRepository.findByUuid(claimUuid).orElseThrow(ClaimNotFoundException::new))</span>
<span class="nc" id="L166">            .map(claim -&gt; new RoleClaim(role, claim))</span>
<span class="nc" id="L167">            .collect(Collectors.toList());</span>

<span class="nc" id="L169">        List&lt;RoleClaim&gt; existingRoleClaimsToDelete = new ArrayList&lt;&gt;(existingRoleClaims);</span>
<span class="nc" id="L170">        existingRoleClaimsToDelete.removeAll(newRoleClaims);</span>
<span class="nc" id="L171">        newRoleClaims.removeAll(existingRoleClaims);</span>

<span class="nc" id="L173">        transactionTemplate.execute(new TransactionCallbackWithoutResult() {</span>
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus status) {
<span class="nc" id="L176">                roleRepository.saveAndFlush(role);</span>
<span class="nc" id="L177">                RoleHistory roleHistory = RoleHistory.builder()</span>
<span class="nc" id="L178">                    .id(new RoleHistory.RoleHistoryId(role.getId()))</span>
<span class="nc" id="L179">                    .uuid(role.getUuid())</span>
<span class="nc" id="L180">                    .name(role.getName())</span>
<span class="nc" id="L181">                    .status(role.getStatus())</span>
<span class="nc" id="L182">                    .performedBy(role.getPerformedBy())</span>
<span class="nc" id="L183">                    .build();</span>
<span class="nc" id="L184">                roleHistoryRepository.save(roleHistory);</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (!existingRoleClaimsToDelete.isEmpty()) {</span>
<span class="nc" id="L187">                    roleClaimRepository.deleteAll(existingRoleClaimsToDelete);</span>
                }
<span class="nc bnc" id="L189" title="All 2 branches missed.">                if (!newRoleClaims.isEmpty()) {</span>
<span class="nc" id="L190">                    roleClaimRepository.saveAll(newRoleClaims);</span>
                }
<span class="nc" id="L192">            }</span>
        });
<span class="nc" id="L194">        RoleDto roleDto = roleMapper.convertToDto(role);</span>
<span class="nc" id="L195">        List&lt;ClaimDto&gt; claimDtos = role.getRoleClaims().stream()</span>
<span class="nc" id="L196">            .map(RoleClaim::getClaim)</span>
<span class="nc" id="L197">            .map(claim -&gt; claimMapper.convertToClaimDto(claim))</span>
<span class="nc" id="L198">            .collect(Collectors.toList());</span>
<span class="nc" id="L199">        roleDto.setClaims(claimDtos);</span>
<span class="nc" id="L200">        return roleDto;</span>
    }

    @Override
    @Transactional
    public void deleteRole(UUID uuid) {
<span class="nc" id="L206">        Long deletedBy = -1l;</span>
//        userRepository.findIdByUuid(authenticationFacade.getUserId())
//            .orElseThrow(InvalidUserException::new);

<span class="nc" id="L210">        Role role = roleRepository.findByUuid(uuid)</span>
<span class="nc" id="L211">            .orElseThrow(RoleNotFoundException::new);</span>
<span class="nc" id="L212">        role.setStatus(Status.DELETED);</span>
<span class="nc" id="L213">        role.setPerformedBy(deletedBy);</span>

<span class="nc" id="L215">        List&lt;UserRole&gt; userRoles = userRoleRepository.findByRole(role);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (!userRoles.isEmpty()) {</span>
<span class="nc" id="L217">            throw new UserManagementException(ErrorGenerator.generateForCode(&quot;1021&quot;));</span>
        }

<span class="nc" id="L220">        transactionTemplate.execute(new TransactionCallbackWithoutResult() {</span>
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus status) {
<span class="nc" id="L223">                roleClaimRepository.deleteAll(role.getRoleClaims());</span>
<span class="nc" id="L224">                roleRepository.delete(role);</span>
<span class="nc" id="L225">                RoleHistory roleHistory = RoleHistory.builder()</span>
<span class="nc" id="L226">                    .id(new RoleHistory.RoleHistoryId(role.getId()))</span>
<span class="nc" id="L227">                    .uuid(role.getUuid())</span>
<span class="nc" id="L228">                    .name(role.getName())</span>
<span class="nc" id="L229">                    .status(role.getStatus())</span>
<span class="nc" id="L230">                    .performedBy(role.getPerformedBy())</span>
<span class="nc" id="L231">                    .build();</span>
<span class="nc" id="L232">                roleHistoryRepository.save(roleHistory);</span>
<span class="nc" id="L233">            }</span>
        });
<span class="nc" id="L235">    }</span>
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span>
</div>
</body>
</html>